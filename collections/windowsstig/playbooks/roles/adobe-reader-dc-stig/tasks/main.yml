---
# tasks file for base
- name: Download {{ gitname }} to specified path only if modified
  ansible.windows.win_get_url:
    url: "{{ gitrepo }}"
    dest: "{{ gitdir }}"
    force: no

- name: Fix Windows Path Character Limit
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem
    name: LongPathsEnabled
    data: 1
    type: dword

# Unzip .zip file, recursively decompresses the contained zips and removes all unneeded compressed files after completion.
- name: Recursively decompress zip files
  community.windows.win_unzip:
    src: "{{ gitdir }}"
    dest: "{{ zipdir }}"
    recurse: yes
    delete_archive: yes

- name: Run the STIG Script
  ansible.windows.win_powershell:
    chdir: "{{ gitdir }}"
    script: |
      try{
      
        powershell.exe -ExecutionPolicy ByPass -File "{{ zipdir }}/*.ps1"

      } Catch {

        $Ansible.failed = $true

      }  